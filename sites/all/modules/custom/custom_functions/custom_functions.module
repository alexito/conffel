<?php

function get_form_tarjeta_de_produccion() {
  global $user;
  module_load_include('inc', 'node', 'node.pages'); 
  $node_form = new stdClass;
  $node_form->type = 'tarjeta_de_produccion';
  $node_form->language = LANGUAGE_NONE;
  $node_form->uid = $user->uid;
  $node_form->status = 1;
  $node_form->revision = FALSE;
  $node_form->comment = 0;
  $node_form->promote = 0;
  $node_form->sticky = 0;
  $node_form->log = NULL;
  $form = drupal_get_form('tarjeta_de_produccion_node_form', $node_form);
  return drupal_render($form);
}

function custom_functions_form_alter(&$form, &$form_state, $form_id) {
  $a = 0;
  if($form_id == "tarjeta_de_produccion_node_form"){
    $tem = explode('/', $_GET['q']);
    if($tem[0] == 't-produccion' && !isset($form['nid']['#value'])){
      $tarjetas = get_t_producciones_del_corte($tem[1]);
      $info = get_corte_values(null, null, $tem[1], $tarjetas);      
      
      $cc = array();
      foreach($info->cc as $tem_cc){
        $cc[$tem_cc->color_tid] = $tem_cc->color;
      }
      
      $form['tp_color'] = array(
        '#title'    => t('Seleccione un color'),
        '#type' => 'select',
        '#options' => $cc,
        '#required' => TRUE,
      );
      
      $tt = array();
      
      foreach($info->tt as $tem_tt){
        $faltan = $tem_tt->subtotal;
        if($tarjetas != NULL){
          $faltan = $tem_tt->subtotal - $tarjetas->tallas[$tem_tt->talla_tid];
        }
        
        $disabled = FALSE;
        $mensaje = 'Faltan: <b>' . $faltan . '</b> por completar.';
        
        
        if($faltan <= 0){
          $disabled = TRUE;
          $mensaje = 'Esta talla esta <b>COMPLETA</b>';
        }
        $form['tt_' . $tem_tt->talla_tid] = array(
          '#attributes' => array(
            'data-max' => $faltan,
            'data-custom-num' => 1
          ),
          '#title'    => t('Talla: ' . $tem_tt->talla . ' (' . $mensaje . ')'),
          '#type'     => 'textfield',
          '#default_value' => $faltan,
          '#disabled' => $disabled,
          '#required' => TRUE,
          '#description' => 'Máximo ' . $faltan,
        );
      }
    }
        
    $form['field_color']['#access'] = FALSE;
    $form['field_talla_y_cantidad']['#access'] = FALSE;
    $form['field_nodo_corte']['#access'] = FALSE;
    
    $form['actions']['submit']['#submit'][] = 'custom_submit';
  }
}
function custom_submit($form, &$form_state){
  $form_state['redirect'] = 'imprimir-tarjeta-produccion/'. $form_state['nid']; 
}
function custom_functions_node_presave($node){
  if($node->type == 'tarjeta_de_produccion'){
    $tem = explode('/', $_GET['q']);
    
    $node->field_color[LANGUAGE_NONE][0]['tid'] = $node->tp_color;
    $node->field_nodo_corte[LANGUAGE_NONE][0]['nid'] = $tem[1];
    $data = '';
    
    $v = taxonomy_vocabulary_machine_name_load('tallas');
    $terms = taxonomy_get_tree($v->vid);
    foreach ($terms as $term) {
      $term_tid = 'tt_' . $term->tid;
      if(isset($node->$term_tid)){
        if($data != '')
          $data .= '_';
        $data .= $term->tid . ',' . $node->$term_tid;
      }      
    }    
    $node->field_talla_y_cantidad[LANGUAGE_NONE][0]['value'] = $data;
    
  }
}

function get_t_producciones_del_corte($nid){
  
  $query = new EntityFieldQuery();
  $result = $query
    ->entityCondition('entity_type', 'node')
    ->entityCondition('bundle', 'tarjeta_de_produccion')
    ->propertyCondition('status', 1)
    ->fieldCondition('field_nodo_corte', 'nid', $nid, '=')
    ->execute();
  
  if (isset($result['node'])) {
    $nids = array_keys($result['node']);
    $nodes = node_load_multiple($nids);
    
    $resp = new stdClass();
    $resp->tallas = array();
    $resp->tarjetas = array();
    foreach($nodes as $node){
      $resp->tarjetas[] = $node;
      $wrapper = entity_metadata_wrapper('node', $node);
      $color = $wrapper->field_color->value();
      $detalle = $wrapper->field_talla_y_cantidad->value();
            
      $tallas = explode('_', $detalle);
      foreach($tallas as $talla){
        $tem = explode(',', $talla);
        
        if(!isset($resp->tallas[$tem[0]])){
          $resp->tallas[$tem[0]] = 0;
        }
        
        $resp->tallas[$tem[0]] = $resp->tallas[$tem[0]] + $tem[1];
      }      
    }
    
    return $resp;
  }
  
  return null;
}

function get_corte_values($data, $row, $nid = 0, $tarjetas = NULL){
  $resp = new stdClass();
  $resp->suma_color_capa = 0;
  $resp->suma_total = 0;
  $resp->suma_faltan = 0;
  if($nid == 0){
    $node = node_load($data->nid);
    $tarjetas = get_t_producciones_del_corte($data->nid);
  } else {
    $node = node_load($nid);    
  }
    
  $items_cc = field_get_items('node', $node, 'field_color_y_capa');
  
  $i = 0;
  $resp->cc = array();
  $resp->html_cc = '<table><thead><tr><th>Color</th><th>Capas</th></tr></thead><tbody>';
  foreach ($items_cc as $item) {
    $fc = field_collection_field_get_entity($item);
    $term = taxonomy_term_load($fc->field_color[LANGUAGE_NONE][0]['tid']);
    $resp->cc[$i] = new stdClass();
    $resp->cc[$i]->color_tid = $term->tid;
    $resp->cc[$i]->color = $term->name;
    $resp->cc[$i]->capa = $fc->field_capas[LANGUAGE_NONE][0]['value'];
    $resp->html_cc .= '<tr><td>' . $resp->cc[$i]->color .'</td><td>' . $resp->cc[$i]->capa . '</td></tr>';
    $resp->suma_color_capa = $resp->suma_color_capa + $fc->field_capas[LANGUAGE_NONE][0]['value'];    
    $i++;
  }
  $resp->html_cc .= '</tbody><tfoot><tr><td>Total: </td><td>' . $resp->suma_color_capa . '</td></tr></tfoot></table>';
  
  
  
  $items_tt = field_get_items('node', $node, 'field_talla_y_tanto');
  $i = 0;
  $resp->tt = array();
  $resp->html_tt = '<table><thead><tr><th>Talla</th><th>Tanto</th><th>Subtotal</th><th>Faltan</th></tr></thead><tbody>';
  foreach ($items_tt as $item) {    
    $fc = field_collection_field_get_entity($item);
    $term = taxonomy_term_load($fc->field_talla[LANGUAGE_NONE][0]['tid']);
    $resp->tt[$i] = new stdClass();
    $resp->tt[$i]->talla_tid = $term->tid;
    $resp->tt[$i]->talla = $term->name;
    $resp->tt[$i]->tanto = $fc->field_tanto[LANGUAGE_NONE][0]['value'];
    $resp->tt[$i]->subtotal = ($resp->tt[$i]->tanto * $resp->suma_color_capa);
    
    $faltan = $resp->tt[$i]->subtotal;
    if($tarjetas != NULL){
      $faltan = $resp->tt[$i]->subtotal - $tarjetas->tallas[$term->tid];
    }
    
    $resp->html_tt .= '<tr><td>' . $resp->tt[$i]->talla .'</td><td>' . $resp->tt[$i]->tanto .
            '</td><td>' . $resp->tt[$i]->subtotal . '</td><td>' .
            $faltan .'</td></tr>';
    
    $resp->suma_total = $resp->suma_total + ($resp->tt[$i]->tanto * $resp->suma_color_capa);
    $resp->suma_faltan = $resp->suma_faltan + $faltan;
    $i++;
  }
  $resp->html_tt .= '</tbody><tfoot><tr><td></td><td>Total: </td><td>' . $resp->suma_total . '</td><td>' . $resp->suma_faltan . '</td></tr></tfoot></table>';
  
  if($tarjetas != NULL){
    $resp->html_tt .= '<span class="col-sm-12"><div style="font-size: 11px;"><b>Tarjetas de Producción: </b></div>';
    foreach ($tarjetas->tarjetas as $t ){
      $resp->html_tt .= '<a target="_blank" href="imprimir-tarjeta-produccion/' . $t->nid . '">' . $t->nid . '</a>, ';
    }
    $resp->html_tt .= '</span>';
  }
  
  $resp->html_actions = getActionsLinks($node);
  
  $resp->user = user_load($node->uid);
  $resp->node = $node;
  $resp->modelo = taxonomy_term_load($node->field_modelo[LANGUAGE_NONE][0]['tid']);
  $resp->tela = taxonomy_term_load($node->field_tela[LANGUAGE_NONE][0]['tid']);
  return $resp;
}

function getActionsLinks($node){
  $resp = new stdClass();
  $resp->nueva_tarjeta_produccion = '<ul>' .
          '<li>' . l('Crear Tarjeta de Producción', 't-produccion/' . $node->nid, array('attributes' => array('target'=>'_blank'))) . '</li>' . 
          '<li>' . l('Imprimir Corte', 'print/imprimir-corte/' . $node->nid, array('attributes' => array('target'=>'_blank'))) . '</li>' .
          '<li>' . '<a href="node/' . $node->nid . '/edit?destination=inicio?nid=' . $node->nid . '">Editar Corte</a></li>' .
          '</ul>';
  return $resp;
}



function softTrim($text, $count, $wrapText='...'){
    if(strlen($text)>$count){
        preg_match('/^.{0,' . $count . '}(?:.*?)\b/siu', $text, $matches);
        $text = $matches[0];
    }else{
        $wrapText = '';
    }
    return $text . $wrapText;
}

/**
 * Implement hook_menu
 */
 function custom_functions_menu(){
   $items['guardar-diario'] = array(
    'page callback' => '_custom_functions_guardar_diario',
    'access arguments' => array('access content'),
    'type' => MENU_CALLBACK,
  );
  $items['imprimir-corte/%node'] = array(
    'page callback' => '_custom_functions_imprimir_corte',
    'page arguments' => array(1),
    'access arguments' => array('access content'),
    'type' => MENU_CALLBACK,
  );
  $items['imprimir-tarjeta-produccion/%node'] = array(
    'page callback' => '_custom_functions_imprimir_tarjeta_produccion',
    'page arguments' => array(1),
    'access arguments' => array('access content'),
    'type' => MENU_CALLBACK,
  );
  $items['imprimir-diario/%'] = array(
    'page callback' => '_custom_functions_imprimir_diario',
    'page arguments' => array(1),
    'access arguments' => array('access content'),
    'type' => MENU_CALLBACK,
  );

  return $items;
 }
 
function _custom_functions_imprimir_diario($fecha){
  $output = new stdClass();
  $output->fecha = $fecha;
  $query = new EntityFieldQuery();
  $result = $query
    ->entityCondition('entity_type', 'node')
    ->entityCondition('bundle', 'diario')
    ->propertyCondition('status', 1)
    ->fieldCondition('field_fecha_diario', 'value', $fecha . '% %00', 'like')
    ->fieldOrderBy('field_modulo', 'tid', 'asc')
    ->execute();
  if (isset($result['node'])) {
    $nids = array_keys($result['node']);
    $output->nodes = node_load_multiple($nids);    
  }
    
   return theme('imprimir_diario', array('output' => $output));
 }
 
 function _custom_functions_imprimir_corte($node){   
   $output = get_corte_values(null, null, $node->nid, null);
   return theme('imprimir_corte', array('output' => $output));
 }
 
 function _custom_functions_imprimir_tarjeta_produccion($node){   
   $wrapper = entity_metadata_wrapper('node', $node);
   $node->cliente_nombre = $wrapper->field_cliente->name->value();
   $node->modelo_nombre = $wrapper->field_nodo_corte->field_modelo->name->value();
   $node->color_nombre = $wrapper->field_color->name->value();
   $node->tela_nombre = $wrapper->field_nodo_corte->field_tela->name->value();
   $node->corte_fecha = date('Y-m-d', $wrapper->field_nodo_corte->created->value());
   
   $corte = node_load($node->field_nodo_corte[LANGUAGE_NONE][0]['nid']);
   $user_corte = user_load($corte->uid);
   if(isset($user_corte->field_nombre_y_apellido[LANGUAGE_NONE][0])){
     $node->user_corte_nombre = $user_corte->field_nombre_y_apellido[LANGUAGE_NONE][0]['value'];
   }else{
     $node->user_corte_nombre = $corte->uid;
   }
   
   $tc = $wrapper->field_talla_y_cantidad->value();
   
   $tem1 = explode('_', $tc);
   
   $tallas_cantidades = array();
   $cantidad_total = 0;
   $i = 0;
   foreach($tem1 as $tc){
     $tem2 = explode(',', $tc);
     $term = taxonomy_term_load($tem2[0]);
     
     $tallas_cantidades[$i] = new stdClass();
     $tallas_cantidades[$i]->talla = $term->name;
     $tallas_cantidades[$i++]->cantidad = $tem2[1];
     
     $cantidad_total = $cantidad_total + $tem2[1];
   }
   
   $node->tallas_cantidades = $tallas_cantidades;
   $node->cantidad_total = $cantidad_total;
   
   
   
   $a = 0;
   
   return theme('imprimir_tarjeta_produccion', array('output' => $node));
 }
 
 function _custom_functions_guardar_diario() {
   if(isset($_POST['info'])){
     $info = $_POST['info'];
     
     foreach($info as $modulo){
        $mod_id = $modulo['mod_id'];
        $tar_ids = explode(',', $modulo['tarjetas']);
        $uds = explode(',', $modulo['uds']);
        $tarjetas = [];
        
        if(count($tar_ids) > 0 && $tar_ids[0] != '' ){
          $modulo['tarjetas'] = $tar_ids;
          $modulo['uds'] = $uds;
          $tarjetas = node_load_multiple($tar_ids, array('type' => 'tarjeta_de_produccion'));
        }
        if(count($tarjetas) > 0){
          crear_contenido($tarjetas, $modulo);
        }
     }     
   }
   
  $data = array("ok");
  return drupal_json_output($data);
}

function crear_contenido($tarjetas, $modulo){
  global $user;
  module_load_include('inc', 'entity', 'includes/entity.controller');

  $node = new stdClass();
  $node->title = "Diario " . date('Y-m-d') . ' 00:00:00';
  $node->type = "diario";
  node_object_prepare($node); // Sets some defaults. Invokes hook_prepare() and hook_node_prepare().
  $node->language = LANGUAGE_NONE; // Or e.g. 'en' if locale is enabled
  $node->uid = $user->uid; 
  $node->status = 1; //(1 or 0): published or not
  $node->promote = 0; //(1 or 0): promoted to front page
  $node->comment = 0; // 0 = comments disabled, 1 = read only, 2 = read/write
  
  $node->field_fecha_diario[LANGUAGE_NONE][0]['value'] = date('Y-m-d') . ' 00:00:00';
  $node->field_fecha_diario[LANGUAGE_NONE][0]['value2'] = date('Y-m-d') . ' 00:00:00';
  $node->field_fecha_diario[LANGUAGE_NONE][0]['offset'] = '-18000';
  $node->field_fecha_diario[LANGUAGE_NONE][0]['offset2'] = '-18000';
  $node->field_fecha_diario[LANGUAGE_NONE][0]['show_todate'] = true;
  $node->field_fecha_diario[LANGUAGE_NONE][0]['timezone'] = 'America/Guayaquil';
  $node->field_fecha_diario[LANGUAGE_NONE][0]['timezone_db'] = 'America/Guayaquil';
  $node->field_fecha_diario[LANGUAGE_NONE][0]['date_type'] = 'detetime';
  $node->field_modulo[LANGUAGE_NONE][0]['tid'] = $modulo['mod_id'];
    
  $term = taxonomy_term_load($modulo['mod_id']);
  
  $tarj_finales = array();
  $emp_finales = array();
  
  $horas_total = 0;  
  $min_prod_total = 0;
  $uds_total = 0;
    
  for($i = 0; $i < count($modulo['tarjetas']); $i++){    

    $tar_id = trim($modulo['tarjetas'][$i]);

    //Obtiene el SAM asignado para cada grupo
    if($term->field_grupo[LANGUAGE_NONE][0]['value'] == '1'){
      $sam = $tarjetas[$modulo['tarjetas'][$i]]->field_confeccion[LANGUAGE_NONE][0]['value'];
    }else if($term->field_grupo[LANGUAGE_NONE][0]['value'] == '1'){
      $sam = $tarjetas[$modulo['tarjetas'][$i]]->field_sam_control_de_calidad[LANGUAGE_NONE][0]['value'];
    }else if($term->field_grupo[LANGUAGE_NONE][0]['value'] == '1'){
      $sam = $tarjetas[$modulo['tarjetas'][$i]]->field_terminado[LANGUAGE_NONE][0]['value'];
    }else if($term->field_grupo[LANGUAGE_NONE][0]['value'] == '1'){
      $sam = $tarjetas[$modulo['tarjetas'][$i]]->field_sam_estampado[LANGUAGE_NONE][0]['value'];
    }else if($term->field_grupo[LANGUAGE_NONE][0]['value'] == '1'){
      $sam = $tarjetas[$modulo['tarjetas'][$i]]->field_sam_bordado[LANGUAGE_NONE][0]['value'];
    }

    $uds = trim($modulo['uds'][$i]);
    $min_prod = $sam * $uds;

    $values = array(
      'field_name' => 'field_tarjeta',
      'field_det_tarjeta' => array(
        LANGUAGE_NONE => array(array('nid' => $tar_id)),
      ),
      'field_det_uds' => array(
        LANGUAGE_NONE => array(array('value' => $uds)),
      ),
      'field_det_sam' => array(
        LANGUAGE_NONE => array(array('value' => $sam)),
      ),
      'field_det_min_prod' => array(
        LANGUAGE_NONE => array(array('value' => $min_prod)),
      )
    );
    $entity = entity_create('field_collection_item', $values);
    $entity->setHostEntity('node', $node);
    $entity->save();

    $min_prod_total = $min_prod_total + $min_prod;
    $uds_total = $uds_total + $uds;
  }
  
  
  $node->field_min_prod_total[LANGUAGE_NONE][0]['value'] = $min_prod_total;
  $node->field_uds_total[LANGUAGE_NONE][0]['value'] = $uds_total;
  
  //Obtiene el total de las horas
  foreach($modulo['empleados'] as $emp){
    $horas_total = $horas_total + intval($emp['rh']) + 0;
  }
  
  $node->field_horas_total[LANGUAGE_NONE][0]['value'] = $horas_total;
  
  $tem1 = $horas_total * 60;
  $variable = ($min_prod_total / $tem1);
  
  $node->field_variable[LANGUAGE_NONE][0]['value'] = $variable;
  
  $us_total = 0;
  
  $i = 0;  
  foreach($modulo['empleados'] as $emp){    
    $tem2 = intval($emp['rh']) * 60;
    $vxm = floatval($modulo['vxm']);
    $us = $variable * $vxm * floatval($tem2);
        
    $values = array(
      'field_name' => 'field_detalle',
      'field_empleado' => array(
        LANGUAGE_NONE => array(array('nid' => $emp['emp_id'])),
      ),
      'field_v_min' => array(
        LANGUAGE_NONE => array(array('value' => $modulo['vxm'])),
      ),
      'field_horas' => array(
        LANGUAGE_NONE => array(array('value' => $emp['rh'])),
      ),
      'field_us_subtotal' => array(
        LANGUAGE_NONE => array(array('value' => $us)),
      )
    );
    $entity = entity_create('field_collection_item', $values);
    $entity->setHostEntity('node', $node);
    $entity->save();
    
    $us_total = $us_total + $us;
    
    $i++;
  }
  
  $node->field_us_total[LANGUAGE_NONE][0]['value'] = $us_total;
  
  $node = node_submit($node); // Prepare node for saving
  node_save($node);
  
  return $node->nid;
}